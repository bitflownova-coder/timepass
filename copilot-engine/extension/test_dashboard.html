<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Copilot Engine Dashboard - Debug Test</title>
<style>
:root {
  --vscode-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --vscode-font-size: 13px;
  --vscode-foreground: #cccccc;
  --vscode-editor-background: #1e1e1e;
  --vscode-panel-background: #252526;
  --vscode-panel-border: #3c3c3c;
  --vscode-button-background: #0e639c;
  --vscode-button-foreground: #ffffff;
  --vscode-button-hoverBackground: #1177bb;
  --vscode-input-background: #3c3c3c;
  --vscode-input-foreground: #cccccc;
  --vscode-input-border: #3c3c3c;
  --vscode-editor-font-family: 'Cascadia Code', Consolas, monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--vscode-font-family);
  font-size: var(--vscode-font-size);
  color: var(--vscode-foreground);
  background: var(--vscode-editor-background);
  line-height: 1.4;
  padding: 0;
}
.shell { max-width: 900px; margin: 0 auto; padding: 16px; }

/* Header */
.header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--vscode-panel-border); }
.header h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.header .emoji { font-size: 22px; }
.header-actions { display: flex; gap: 6px; }

/* Buttons */
.icon-btn {
  background: var(--vscode-button-background);
  color: var(--vscode-button-foreground);
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: background 0.15s;
}
.icon-btn:hover { background: var(--vscode-button-hoverBackground); }
.icon-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.icon-btn.secondary { background: var(--vscode-input-background); }
.icon-btn.secondary:hover { background: #4a4a4a; }
.icon-btn.primary { background: #388a34; }
.icon-btn.primary:hover { background: #45a840; }

/* Status Bar */
.status-bar { display: flex; gap: 16px; padding: 8px 12px; background: var(--vscode-panel-background); border-radius: 6px; margin-bottom: 16px; flex-wrap: wrap; }
.status-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-dot.green { background: #4ade80; }
.status-dot.yellow { background: #facc15; }
.status-dot.red { background: #ef4444; }
.status-dot.gray { background: #6b7280; }

/* Tabs */
.tabs { display: flex; gap: 2px; margin-bottom: 16px; border-bottom: 1px solid var(--vscode-panel-border); }
.tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; opacity: 0.7; transition: all 0.15s; font-size: 13px; }
.tab:hover { opacity: 1; background: var(--vscode-panel-background); }
.tab.active { opacity: 1; border-bottom-color: var(--vscode-button-background); }

/* Tab Content */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Cards */
.card { background: var(--vscode-panel-background); border-radius: 8px; margin-bottom: 16px; overflow: hidden; }
.card-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--vscode-panel-border); }
.card-title { font-weight: 600; font-size: 14px; }
.card-body { padding: 16px; }
.card-body.no-pad { padding: 0; }

/* Scan Grid */
.scan-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
.scan-btn {
  background: var(--vscode-input-background);
  border: 1px solid var(--vscode-panel-border);
  border-radius: 8px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.scan-btn:hover { background: #3a3a3a; border-color: var(--vscode-button-background); }
.scan-btn.primary { border-color: #388a34; }
.scan-btn .icon { font-size: 24px; display: block; margin-bottom: 8px; }
.scan-btn .label { font-weight: 600; font-size: 13px; display: block; margin-bottom: 4px; }
.scan-btn .desc { font-size: 11px; opacity: 0.6; }
.scan-btn.loading { opacity: 0.5; pointer-events: none; }

/* Results */
.results-body { max-height: 400px; overflow-y: auto; }
.result-row { display: flex; align-items: flex-start; gap: 12px; padding: 10px 16px; border-bottom: 1px solid var(--vscode-panel-border); cursor: pointer; transition: background 0.1s; }
.result-row:hover { background: var(--vscode-input-background); }
.result-row:last-child { border-bottom: none; }
.result-icon { font-size: 16px; flex-shrink: 0; padding-top: 2px; }
.result-content { flex: 1; min-width: 0; }
.result-msg { font-size: 13px; margin-bottom: 2px; word-break: break-word; }
.result-meta { font-size: 11px; opacity: 0.5; }
.result-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; flex-shrink: 0; }
.badge-critical { background: #7f1d1d; color: #fecaca; }
.badge-high { background: #7c2d12; color: #fed7aa; }
.badge-medium { background: #713f12; color: #fef08a; }
.badge-low { background: #14532d; color: #bbf7d0; }

/* Empty State */
.empty-state { text-align: center; padding: 40px 20px; }
.empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
.empty-state .title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
.empty-state .desc { font-size: 13px; opacity: 0.6; }

/* Loading */
.loading-state { display: flex; flex-direction: column; align-items: center; padding: 40px; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--vscode-panel-border); border-top-color: var(--vscode-button-background); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
.stat-card { background: var(--vscode-input-background); border-radius: 8px; padding: 16px; text-align: center; }
.stat-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
.stat-label { font-size: 11px; opacity: 0.6; }
.stat-card.danger .stat-value { color: #ef4444; }
.stat-card.warning .stat-value { color: #fb923c; }
.stat-card.success .stat-value { color: #4ade80; }

/* Backend Panel */
.backend-panel { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.backend-info { flex: 1; min-width: 200px; }
.backend-state { font-weight: 600; margin-bottom: 2px; }
.backend-meta { font-size: 11px; opacity: 0.5; }
.backend-actions { display: flex; gap: 6px; }

/* Log Output */
.log-output { background: var(--vscode-editor-background); border: 1px solid var(--vscode-panel-border); border-radius: 4px; padding: 12px; font-family: var(--vscode-editor-font-family); font-size: 11px; max-height: 200px; overflow-y: auto; line-height: 1.6; }
.log-output:empty::before { content: 'No logs yet'; opacity: 0.4; }

/* Issues List */
.issues-summary { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
.issue-count { display: flex; align-items: center; gap: 4px; font-size: 12px; padding: 4px 10px; border-radius: 4px; background: var(--vscode-editor-background); }
.issue-count.critical { color: #ef4444; }
.issue-count.high { color: #fb923c; }
.issue-count.medium { color: #facc15; }
.issue-count.low { color: #4ade80; }

/* Debug Console (visible at bottom) */
#debugConsole {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #0a0a0a;
  border-top: 2px solid #007acc;
  max-height: 200px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 11px;
  z-index: 9999;
}
#debugConsole .header {
  background: #007acc;
  color: white;
  padding: 4px 12px;
  margin: 0;
  border: 0;
  display: flex;
  justify-content: space-between;
}
#debugConsole .logs {
  padding: 8px 12px;
  color: #ccc;
}
#debugConsole .log-entry {
  padding: 2px 0;
  border-bottom: 1px solid #222;
}
#debugConsole .log-entry.error { color: #f88; }
#debugConsole .log-entry.warn { color: #fb3; }
#debugConsole .log-entry.info { color: #8cf; }
</style>
</head>
<body>
<div class="shell">

<!-- Header -->
<div class="header">
  <h1><span class="emoji">‚ö°</span> Copilot Engine Dashboard</h1>
  <div class="header-actions">
    <button class="icon-btn" onclick="send('refreshDashboard')" id="btnRefresh">‚Üª Refresh</button>
    <button class="icon-btn" onclick="send('showOutput')">üìã Output</button>
    <button class="icon-btn" onclick="send('openSettings')">‚öôÔ∏è Settings</button>
  </div>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <div class="status-item">
    <span id="backendDot" class="status-dot gray"></span>
    <span id="backendLabel">Backend: Checking...</span>
  </div>
  <div class="status-item">
    <span>Port:</span>
    <strong id="portNum">7779</strong>
  </div>
  <div class="status-item">
    <span>Worker:</span>
    <strong id="workerStatus">‚Äî</strong>
  </div>
  <div class="status-item">
    <span>Events:</span>
    <strong id="eventCount">0</strong>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="scans">üîç Scan & Analyze</div>
  <div class="tab" data-tab="results">üìä Results</div>
  <div class="tab" data-tab="health">‚ù§Ô∏è Health</div>
  <div class="tab" data-tab="backend">üñ•Ô∏è Backend</div>
</div>

<!-- Tab: Scans -->
<div class="tab-content active" id="tab-scans">
  <div class="card">
    <div class="card-header">
      <span class="card-title">üéØ Manual Scans</span>
      <span style="font-size:11px;opacity:.5">Click to run ‚Äî results appear below</span>
    </div>
    <div class="card-body">
      <!-- Folder Selection -->
      <div class="folder-selector" style="margin-bottom:16px;padding:12px;background:var(--vscode-editor-background);border-radius:6px;border:1px solid var(--vscode-panel-border);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <span style="font-weight:600;font-size:13px;">üìÅ Scan Target</span>
          <span style="font-size:11px;opacity:.5">(leave empty for entire workspace)</span>
        </div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="folderPath" placeholder="e.g., src/modules or full path..." 
            style="flex:1;padding:8px 12px;background:var(--vscode-input-background);border:1px solid var(--vscode-input-border);border-radius:4px;color:var(--vscode-input-foreground);font-size:12px;">
          <button class="icon-btn secondary" onclick="browseFolders()">üìÇ Browse</button>
          <button class="icon-btn secondary" onclick="clearFolderPath()">‚úï</button>
        </div>
        <div id="folderStatus" style="margin-top:8px;font-size:11px;color:#4ade80;display:none;"></div>
      </div>

      <div class="scan-grid">
        <div class="scan-btn primary" onclick="runScan('initializeWorkspace')" id="btn-initialize">
          <span class="icon">üöÄ</span>
          <span class="label">Initialize</span>
          <span class="desc">Index workspace & build graph</span>
        </div>
        <div class="scan-btn" onclick="runScan('runFullScan')" id="btn-fullscan">
          <span class="icon">üîç</span>
          <span class="label">Full Scan</span>
          <span class="desc">Security + Contracts + All</span>
        </div>
        <div class="scan-btn" onclick="runScan('runSecurityScan')" id="btn-security">
          <span class="icon">üõ°Ô∏è</span>
          <span class="label">Security</span>
          <span class="desc">Find vulnerabilities</span>
        </div>
        <div class="scan-btn" onclick="runScan('runContractScan')" id="btn-contracts">
          <span class="icon">üìã</span>
          <span class="label">API Contracts</span>
          <span class="desc">Validate endpoints</span>
        </div>
        <div class="scan-btn" onclick="runScan('runGitAnalysis')" id="btn-git">
          <span class="icon">üìä</span>
          <span class="label">Git Analysis</span>
          <span class="desc">Review changes & risk</span>
        </div>
        <div class="scan-btn" onclick="runScan('detectEndpoints')" id="btn-endpoints">
          <span class="icon">üåê</span>
          <span class="label">Detect Endpoints</span>
          <span class="desc">Find API routes</span>
        </div>
        <div class="scan-btn" onclick="runScan('detectStack')" id="btn-stack">
          <span class="icon">üîß</span>
          <span class="label">Detect Stack</span>
          <span class="desc">Languages & frameworks</span>
        </div>
      </div>
      
      <!-- Advanced Analysis Section -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--vscode-panel-border);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="font-weight:600;font-size:13px;">üî¨ Advanced Analysis</span>
          <span style="font-size:11px;opacity:.5">(AST-based, reduced false positives)</span>
        </div>
        <div class="scan-grid">
          <div class="scan-btn" onclick="runScan('runAdvancedScan')" id="btn-advanced">
            <span class="icon">üß†</span>
            <span class="label">Full Analysis</span>
            <span class="desc">All analyzers combined</span>
          </div>
          <div class="scan-btn" onclick="runScan('runAstSecurity')" id="btn-ast-security">
            <span class="icon">üîê</span>
            <span class="label">AST Security</span>
            <span class="desc">Smart vulnerability scan</span>
          </div>
          <div class="scan-btn" onclick="runScan('runDeadCode')" id="btn-dead-code">
            <span class="icon">üíÄ</span>
            <span class="label">Dead Code</span>
            <span class="desc">Unused functions & imports</span>
          </div>
          <div class="scan-btn" onclick="runScan('runCodeQuality')" id="btn-quality">
            <span class="icon">üìê</span>
            <span class="label">Code Quality</span>
            <span class="desc">Complexity & maintainability</span>
          </div>
          <div class="scan-btn" onclick="runScan('runRuntimeErrors')" id="btn-runtime">
            <span class="icon">‚ö†Ô∏è</span>
            <span class="label">Runtime Errors</span>
            <span class="desc">Predict potential crashes</span>
          </div>
          <div class="scan-btn" onclick="runScan('runDependencies')" id="btn-deps">
            <span class="icon">üì¶</span>
            <span class="label">Dependencies</span>
            <span class="desc">CVEs & circular imports</span>
          </div>
          <div class="scan-btn" onclick="runScan('runCopilotIssues')" id="btn-copilot">
            <span class="icon">ü§ñ</span>
            <span class="label">Copilot Issues</span>
            <span class="desc">TODOs, magic numbers, debug</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline Results -->
  <div id="scanResultsPanel" style="display:none">
    <div class="card">
      <div class="card-header">
        <span class="card-title" id="resultsTitle">üìä Scan Results</span>
        <button class="icon-btn" onclick="clearResults()">‚úï Clear</button>
      </div>
      <div class="card-body no-pad">
        <div id="resultsSummary" class="issues-summary" style="padding:12px 16px;border-bottom:1px solid var(--vscode-panel-border)"></div>
        <div id="resultsBody" class="results-body"></div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="scanLoading" style="display:none">
    <div class="card">
      <div class="card-body">
        <div class="loading-state">
          <div class="spinner"></div>
          <div class="text" id="loadingText">Running scan...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab: Results History -->
<div class="tab-content" id="tab-results">
  <div class="card">
    <div class="card-header">
      <span class="card-title">üìä Last Scan Results</span>
    </div>
    <div class="card-body">
      <div id="lastResults">
        <div class="empty-state">
          <div class="icon">üì≠</div>
          <div class="title">No scan results yet</div>
          <div class="desc">Run a scan from the "Scan & Analyze" tab</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab: Health -->
<div class="tab-content" id="tab-health">
  <div class="card">
    <div class="card-header">
      <span class="card-title">‚ù§Ô∏è Workspace Health</span>
      <button class="icon-btn" onclick="send('refreshDashboard')">‚Üª Refresh</button>
    </div>
    <div class="card-body">
      <div id="healthContent">
        <div class="empty-state">
          <div class="icon">üìä</div>
          <div class="title">No health data</div>
          <div class="desc">Click "Initialize" to index your workspace first</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab: Backend -->
<div class="tab-content" id="tab-backend">
  <div class="card">
    <div class="card-header">
      <span class="card-title">üñ•Ô∏è Backend Server</span>
    </div>
    <div class="card-body">
      <div class="backend-panel">
        <div class="backend-info">
          <div class="backend-state" id="backendState">Checking...</div>
          <div class="backend-meta" id="backendMeta">Port: 7779 | PID: ‚Äî | Uptime: ‚Äî</div>
        </div>
        <div class="backend-actions">
          <button class="icon-btn primary" id="btnStart" onclick="send('startBackend')">‚ñ∂ Start</button>
          <button class="icon-btn" id="btnStop" onclick="send('stopBackend')" disabled>‚èπ Stop</button>
          <button class="icon-btn" id="btnRestart" onclick="send('restartBackend')" disabled>üîÑ Restart</button>
          <button class="icon-btn" onclick="send('refreshBackend')">‚Üª Check</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="card-title">üìú Server Logs</span>
    </div>
    <div class="card-body">
      <div id="logsContent" class="log-output"></div>
    </div>
  </div>
</div>

</div>

<!-- Debug Console -->
<div id="debugConsole">
  <div class="header">
    <span>üîß Debug Console</span>
    <button onclick="clearDebugConsole()" style="background:none;border:none;color:white;cursor:pointer;">Clear</button>
  </div>
  <div class="logs" id="debugLogs"></div>
</div>

<script>
// ============================================================
// DEBUG CONSOLE - captures all logs and errors
// ============================================================
const debugLogs = document.getElementById('debugLogs');

function debugLog(msg, type = 'info') {
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.textContent = '[' + time + '] ' + msg;
  debugLogs.appendChild(entry);
  debugLogs.scrollTop = debugLogs.scrollHeight;
  
  // Also log to real console
  if (type === 'error') console.error(msg);
  else if (type === 'warn') console.warn(msg);
  else console.log(msg);
}

function clearDebugConsole() {
  debugLogs.innerHTML = '';
}

// Capture all errors
window.onerror = function(msg, url, line, col, error) {
  debugLog('ERROR: ' + msg + ' at line ' + line, 'error');
  return false;
};

window.addEventListener('unhandledrejection', function(event) {
  debugLog('UNHANDLED PROMISE: ' + event.reason, 'error');
});

// ============================================================
// REAL BACKEND API (connects to localhost:7779)
// ============================================================
debugLog('Script starting...');

const BACKEND_URL = 'http://localhost:7779';

// API helper for making backend calls
async function apiCall(endpoint, method = 'GET', body = null) {
  const options = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (body) options.body = JSON.stringify(body);
  
  debugLog('API call: ' + method + ' ' + endpoint, 'info');
  const response = await fetch(BACKEND_URL + endpoint, options);
  
  if (!response.ok) {
    throw new Error('API error: ' + response.status + ' ' + response.statusText);
  }
  return response.json();
}

// vscode API replacement - makes real API calls
const vscode = {
  postMessage: async function(msg) {
    debugLog('postMessage called: ' + JSON.stringify(msg), 'info');
    // Normalize folder path - remove quotes, normalize slashes for display
    const rawFolder = (msg.targetFolder || '').replace(/^"|"$/g, '');
    const folderLabel = rawFolder || 'workspace';
    // Use default workspace if not specified
    const workspacePath = rawFolder || 'E:/timepass';
    
    try {
      if (msg.command === 'webviewReady') {
        // Check real backend health
        debugLog('Checking backend health...', 'info');
        try {
          const health = await apiCall('/health');
          handleMessage({ command: 'backendStatus', status: { health: 'healthy', running: true, port: 7779, ...health }});
        } catch (e) {
          debugLog('Backend not responding: ' + e.message, 'error');
          handleMessage({ command: 'backendStatus', status: { health: 'stopped', running: false, port: 7779 }});
        }
      }
      else if (msg.command === 'selectFolder') {
        debugLog('Folder selection requested', 'info');
      }
      else if (msg.command === 'runFullScan') {
        debugLog('Running REAL full scan on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/pipeline/full-scan', 'POST', { workspace_path: workspacePath });
          debugLog('Full scan complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'fullScan',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Full scan error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runSecurityScan') {
        debugLog('Running REAL security scan on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/security/scan-workspace', 'POST', { workspace_path: workspacePath });
          debugLog('Security scan complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'security',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Security scan error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'initializeWorkspace') {
        debugLog('Running REAL workspace initialization on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/autonomous/initialize', 'POST', { workspace_path: workspacePath });
          debugLog('Initialize complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'initialize',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Initialize error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runContractScan') {
        debugLog('Running REAL contract scan on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/contracts/analyze', 'POST', { workspace_path: workspacePath });
          debugLog('Contract scan complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'contracts',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Contract scan error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runGitAnalysis') {
        debugLog('Running REAL git analysis on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/git/diff', 'POST', { workspace_path: workspacePath });
          debugLog('Git analysis complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'gitAnalysis',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Git analysis error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'detectEndpoints') {
        debugLog('Running REAL endpoint detection on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/api/detect', 'POST', { workspace_path: workspacePath });
          debugLog('Endpoint detection complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'endpoints',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Endpoint detection error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'detectStack') {
        debugLog('Running REAL stack detection on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/stack/detect', 'POST', { workspace_path: workspacePath });
          debugLog('Stack detection complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'stack',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Stack detection error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      // ========== ADVANCED ANALYSIS ==========
      else if (msg.command === 'runAdvancedScan') {
        debugLog('Running FULL advanced analysis on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/full', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('Advanced analysis complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'advancedFull',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Advanced analysis error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runAstSecurity') {
        debugLog('Running AST security scan on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/security-ast', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('AST security complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'astSecurity',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('AST security error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runDeadCode') {
        debugLog('Running dead code detection on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/dead-code', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('Dead code detection complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'deadCode',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Dead code error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runCodeQuality') {
        debugLog('Running code quality analysis on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/code-quality', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('Code quality analysis complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'codeQuality',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Code quality error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runRuntimeErrors') {
        debugLog('Running runtime error prediction on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/runtime-errors', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('Runtime error prediction complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'runtimeErrors',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Runtime error prediction error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runDependencies') {
        debugLog('Running dependency analysis on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/dependencies', 'POST', { workspace_path: workspacePath });
          debugLog('Dependency analysis complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'dependencies',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Dependency analysis error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
      else if (msg.command === 'runCopilotIssues') {
        debugLog('Running copilot issue detection on: ' + workspacePath, 'info');
        handleMessage({ command: 'scanStarted' });
        try {
          const result = await apiCall('/analysis/copilot-issues', 'POST', { workspace_path: workspacePath, max_files: 500 });
          debugLog('Copilot issue detection complete: ' + JSON.stringify(result).slice(0, 200), 'info');
          handleMessage({ 
            command: 'scanResults', 
            scanType: 'copilotIssues',
            result: { ...result, scanned_folder: folderLabel }
          });
        } catch (e) {
          debugLog('Copilot issue detection error: ' + e.message, 'error');
          handleMessage({ command: 'scanComplete', success: false, error: e.message });
        }
      }
    } catch (e) {
      debugLog('Unexpected error: ' + e.message, 'error');
    }
  }
};

debugLog('Real API client created - connecting to ' + BACKEND_URL);

// ============================================================
// HELPER FUNCTIONS
// ============================================================
function send(cmd, payload) {
  debugLog('send() called: ' + cmd, 'info');
  vscode.postMessage({ command: cmd, ...(payload || {}) });
}

function esc(s) { 
  return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); 
}

function basename(p) { 
  return (p || '').replace(/\\/g, '/').split('/').pop() || p; 
}

// ============================================================
// STATE
// ============================================================
let currentScan = null;
let lastResults = null;

// ============================================================
// TAB SWITCHING
// ============================================================
debugLog('Setting up tab switching...');

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    debugLog('Tab clicked: ' + this.dataset.tab);
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
  });
});

debugLog('Tab switching setup complete');

// ============================================================
// SCAN FUNCTIONS
// ============================================================
function getTargetFolder() {
  const input = document.getElementById('folderPath');
  return input ? input.value.trim() : '';
}

function runScan(scanType) {
  const folder = getTargetFolder();
  debugLog('runScan() called with: ' + scanType + (folder ? ' [folder: ' + folder + ']' : ' [entire workspace]'));
  currentScan = scanType;
  
  // Include folder in payload if specified
  const payload = folder ? { targetFolder: folder } : {};
  send(scanType, payload);
  
  // Show folder being scanned in loading state
  if (folder) {
    document.getElementById('loadingText').textContent = 'Scanning ' + folder + '...';
  }
}

function browseFolders() {
  debugLog('browseFolders() called');
  // In VS Code, this would call vscode.window.showOpenDialog
  // For test mode, show a simple prompt
  const folder = prompt('Enter folder path to scan:', 'src/');
  if (folder) {
    document.getElementById('folderPath').value = folder;
    showFolderStatus('Folder set: ' + folder);
  }
  send('selectFolder');
}

function clearFolderPath() {
  document.getElementById('folderPath').value = '';
  document.getElementById('folderStatus').style.display = 'none';
  debugLog('Folder path cleared - will scan entire workspace');
}

function showFolderStatus(message, isError) {
  const status = document.getElementById('folderStatus');
  status.textContent = message;
  status.style.color = isError ? '#ef4444' : '#4ade80';
  status.style.display = 'block';
  setTimeout(() => { status.style.display = 'none'; }, 3000);
}

function clearResults() {
  debugLog('clearResults() called');
  document.getElementById('scanResultsPanel').style.display = 'none';
  document.getElementById('resultsBody').innerHTML = '';
  document.getElementById('resultsSummary').innerHTML = '';
}

function enableScanButtons() {
  document.querySelectorAll('.scan-btn').forEach(btn => btn.classList.remove('loading'));
}

// ============================================================
// RENDER FUNCTIONS
// ============================================================
function renderIssueRow(issue) {
  const sev = (issue.severity || 'medium').toUpperCase();
  const icon = sev === 'CRITICAL' ? 'üî¥' : sev === 'HIGH' ? 'üü†' : sev === 'MEDIUM' ? 'üü°' : 'üü¢';
  const badgeClass = sev === 'CRITICAL' ? 'badge-critical' : sev === 'HIGH' ? 'badge-high' : sev === 'MEDIUM' ? 'badge-medium' : 'badge-low';
  // Handle different API response formats
  const filePath = issue.file_path || issue.file || '';
  const line = issue.line_number || issue.line || '';
  const message = issue.message || issue.issue || issue.category || 'Issue detected';
  const category = issue.category || issue.pillar || '';
  // Escape backslashes and quotes for onclick handler
  const escapedPath = filePath.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

  return '<div class="result-row" onclick="openFile(\'' + escapedPath + '\', ' + (line || 1) + ')">' +
    '<span class="result-icon">' + icon + '</span>' +
    '<div class="result-content">' +
      '<div class="result-msg">' + esc(message) + '</div>' +
      '<div class="result-meta">' + basename(filePath) + (line ? ':' + line : '') + (category ? ' ‚Ä¢ ' + esc(category) : '') + '</div>' +
      (issue.suggestion ? '<div class="result-meta" style="color:#facc15;margin-top:2px;">üí° ' + esc(issue.suggestion) + '</div>' : '') +
    '</div>' +
    '<span class="result-badge ' + badgeClass + '">' + sev + '</span>' +
  '</div>';
}

function openFile(path, line) {
  debugLog('openFile() called: ' + path + ':' + line);
  send('openFile', { filePath: path, line: line });
}

function renderScanResults(scanType, result) {
  debugLog('renderScanResults() called: ' + scanType);
  
  const panel = document.getElementById('scanResultsPanel');
  const title = document.getElementById('resultsTitle');
  const summary = document.getElementById('resultsSummary');
  const body = document.getElementById('resultsBody');

  panel.style.display = 'block';
  document.getElementById('scanLoading').style.display = 'none';
  enableScanButtons();

  lastResults = { scanType, result, timestamp: new Date().toISOString() };
  
  // Show scanned folder indicator
  const folderLabel = result.scanned_folder || 'workspace';
  const folderBadge = '<div class="issue-count" style="background:#333;color:#8cf;">üìÅ ' + esc(folderLabel) + '</div>';

  if (scanType === 'fullScan') {
    title.innerHTML = 'üîç Full Scan Results';
    // Full scan has: issues[] (all findings), overall_risk_score, overall_risk_level, security_findings, contract_violations
    // Note: result.security is an OBJECT (not array), result.issues is the main array
    const issues = result.issues || result.findings || [];
    const riskScore = result.overall_risk_score || 0;
    const riskLevel = result.overall_risk_level || 'UNKNOWN';
    const securityCount = result.security_findings || issues.length;
    const contractCount = result.contract_violations || 0;
    
    const critical = issues.filter(i => (i.severity || '').toUpperCase() === 'CRITICAL').length;
    const high = issues.filter(i => (i.severity || '').toUpperCase() === 'HIGH').length;
    const medium = issues.filter(i => (i.severity || '').toUpperCase() === 'MEDIUM').length;
    const low = issues.filter(i => (i.severity || '').toUpperCase() === 'LOW').length;

    const riskColor = riskLevel === 'CRITICAL' ? '#f55' : riskLevel === 'HIGH' ? '#fa2' : riskLevel === 'MEDIUM' ? '#fc0' : '#5f5';
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:' + riskColor + ';color:#000;font-weight:bold;">Risk: ' + (riskScore * 100).toFixed(0) + '% ' + riskLevel + '</div>' +
      '<div class="issue-count critical">üî¥ ' + critical + ' Critical</div>' +
      '<div class="issue-count high">üü† ' + high + ' High</div>' +
      '<div class="issue-count medium">üü° ' + medium + ' Medium</div>' +
      '<div class="issue-count low">üü¢ ' + low + ' Low</div>' +
      '<div class="issue-count">üõ°Ô∏è Security: ' + securityCount + '</div>' +
      '<div class="issue-count">üìã Contracts: ' + contractCount + '</div>';

    body.innerHTML = issues.slice(0, 100).map(i => renderIssueRow(i)).join('');
  } else if (scanType === 'security') {
    title.innerHTML = 'üõ°Ô∏è Security Scan Results';
    const issues = result.issues || result.findings || [];
    
    const critical = issues.filter(i => (i.severity || '').toUpperCase() === 'CRITICAL').length;
    const high = issues.filter(i => (i.severity || '').toUpperCase() === 'HIGH').length;
    const medium = issues.filter(i => (i.severity || '').toUpperCase() === 'MEDIUM').length;
    const low = issues.filter(i => (i.severity || '').toUpperCase() === 'LOW').length;

    summary.innerHTML = folderBadge +
      '<div class="issue-count critical">üî¥ ' + critical + ' Critical</div>' +
      '<div class="issue-count high">üü† ' + high + ' High</div>' +
      '<div class="issue-count medium">üü° ' + medium + ' Medium</div>' +
      '<div class="issue-count low">üü¢ ' + low + ' Low</div>' +
      '<div class="issue-count">Total: ' + issues.length + '</div>';

    body.innerHTML = issues.slice(0, 100).map(i => renderIssueRow(i)).join('');
  } 
  else if (scanType === 'initialize') {
    title.innerHTML = 'üöÄ Initialization Results';
    const steps = result.steps || {};
    summary.innerHTML = folderBadge + (result.initialized || result.already_initialized ? 
      '<div class="issue-count" style="color:#4ade80">‚úÖ Workspace initialized</div>' : 
      '<div class="issue-count critical">‚ùå Initialization failed</div>');
    body.innerHTML = 
      '<div style="padding:16px">' +
        (steps.index ? '<div style="margin-bottom:8px">üìÅ Indexed ' + (steps.index.indexed || 0) + ' files, ' + (steps.index.entities_found || 0) + ' entities</div>' : '') +
        (steps.graph ? '<div style="margin-bottom:8px">üîó Built graph: ' + (steps.graph.file_edges || 0) + ' dependencies</div>' : '') +
        (steps.snapshots ? '<div style="margin-bottom:8px">üì∏ Created ' + steps.snapshots + ' AST snapshots</div>' : '') +
        (result.already_initialized ? '<div style="opacity:.6">Already initialized previously</div>' : '') +
      '</div>';
  }
  else if (scanType === 'contracts') {
    title.innerHTML = 'üìã API Contract Results';
    // Handle real API format: { endpoints, violations, total_violations, auth_coverage }
    const violations = result.violations || [];
    const authCoverage = result.auth_coverage || {};
    const bySeverity = result.violations_by_severity || {};
    const critical = bySeverity.CRITICAL || 0;
    const high = bySeverity.HIGH || 0;
    const medium = bySeverity.MEDIUM || 0;
    const low = bySeverity.LOW || 0;
    
    summary.innerHTML = folderBadge +
      (critical > 0 ? '<div class="issue-count critical">üî¥ ' + critical + ' Critical</div>' : '') +
      (high > 0 ? '<div class="issue-count high">üü† ' + high + ' High</div>' : '') +
      (medium > 0 ? '<div class="issue-count medium">üü° ' + medium + ' Medium</div>' : '') +
      (low > 0 ? '<div class="issue-count low">üü¢ ' + low + ' Low</div>' : '') +
      '<div class="issue-count">Total: ' + (result.total_violations || violations.length) + ' violations</div>' +
      '<div class="issue-count" style="color:#8cf">üìã ' + (result.endpoints || []).length + ' endpoints</div>';
    
    body.innerHTML = 
      '<div style="padding:16px;border-bottom:1px solid var(--vscode-panel-border)">' +
        '<strong>Auth Coverage:</strong> ' + (authCoverage.coverage_percent || 0).toFixed(1) + '% (' + (authCoverage.guarded || 0) + '/' + (authCoverage.total || 0) + ' guarded)' +
        (authCoverage.mutation_unguarded > 0 ? '<span style="color:#fb923c;margin-left:12px">‚ö†Ô∏è ' + authCoverage.mutation_unguarded + ' mutation endpoints unguarded</span>' : '') +
      '</div>' +
      violations.slice(0, 50).map(v => renderIssueRow({
        severity: v.severity,
        message: v.message,
        file_path: v.file_path,
        line_number: v.line_number,
        category: v.category,
        suggestion: v.suggestion
      })).join('');
  }
  else if (scanType === 'gitAnalysis') {
    title.innerHTML = 'üìä Git Analysis Results';
    // Handle real API format: { branch, changes, risk_score, warnings, total_files_changed }
    const changes = result.changes || [];
    const warnings = result.warnings || [];
    const riskLevel = result.risk_score <= 2 ? 'low' : result.risk_score <= 5 ? 'medium' : 'high';
    const riskColor = riskLevel === 'low' ? '#4ade80' : riskLevel === 'medium' ? '#facc15' : '#ef4444';
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="color:#8cf">üåø ' + esc(result.branch || 'unknown') + '</div>' +
      '<div class="issue-count" style="color:' + riskColor + '">‚ö†Ô∏è Risk: ' + (result.risk_score || 0) + '</div>' +
      '<div class="issue-count">üìÅ ' + (result.total_files_changed || changes.length) + ' files changed</div>';
    
    body.innerHTML = 
      (warnings.length ? '<div style="padding:12px 16px;background:#713f12;border-bottom:1px solid var(--vscode-panel-border)">' + warnings.map(w => '<div style="color:#fef08a">‚ö†Ô∏è ' + esc(w) + '</div>').join('') + '</div>' : '') +
      '<div style="padding:12px 16px;border-bottom:1px solid var(--vscode-panel-border)">' +
        '<strong>Changed Files:</strong>' +
      '</div>' +
      changes.slice(0, 30).map(c => {
        const riskBadge = c.risk_level === 'high' ? 'badge-high' : c.risk_level === 'medium' ? 'badge-medium' : 'badge-low';
        return '<div class="result-row">' +
          '<span class="result-icon">' + (c.change_type === 'modified' ? 'üìù' : c.change_type === 'untracked' ? '‚ûï' : 'üìÑ') + '</span>' +
          '<div class="result-content">' +
            '<div class="result-msg">' + esc(c.file) + '</div>' +
            '<div class="result-meta">' + esc(c.change_type) + ' ‚Ä¢ ' + esc(c.details) + '</div>' +
          '</div>' +
          '<span class="result-badge ' + riskBadge + '">' + (c.risk_level || 'low').toUpperCase() + '</span>' +
        '</div>';
      }).join('') + 
      (changes.length > 30 ? '<div style="padding:12px;opacity:.6;text-align:center">... and ' + (changes.length - 30) + ' more files</div>' : '');
  }
  else if (scanType === 'endpoints') {
    title.innerHTML = 'üåê Detected Endpoints';
    const endpoints = result.endpoints || [];
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="color:#4ade80">üåê ' + (result.total_endpoints || endpoints.length) + ' endpoints found</div>' +
      '<div class="issue-count" style="color:#8cf">üìÅ ' + (result.files_scanned || 0) + ' files scanned</div>';
    // Escape file paths for onclick handlers
    body.innerHTML = endpoints.slice(0, 50).map(ep => {
      const escapedFile = (ep.file || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      return '<div class="result-row" onclick="openFile(\'' + escapedFile + '\', ' + (ep.line || 1) + ')">' +
        '<span class="result-icon">üîó</span>' +
        '<div class="result-content">' +
          '<div class="result-msg"><strong style="color:#4ade80">' + esc(ep.method) + '</strong> ' + esc(ep.route || ep.path) + '</div>' +
          '<div class="result-meta">' + basename(ep.file) + ':' + ep.line + ' ‚Ä¢ ' + esc(ep.framework || '') + '</div>' +
        '</div>' +
      '</div>';
    }).join('') + (endpoints.length > 50 ? '<div style="padding:12px;opacity:.6;text-align:center">... and ' + (endpoints.length - 50) + ' more endpoints</div>' : '');
  }
  else if (scanType === 'stack') {
    title.innerHTML = 'üîß Stack Detection Results';
    // Handle real API format: { language, framework, orm, detected_tools }
    const lang = result.language || 'Unknown';
    const framework = result.framework || 'None';
    const orm = result.orm || 'None';
    const tools = result.detected_tools || [];
    const db = result.database || 'None';
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="color:#fb3">üìö ' + lang + '</div>' +
      '<div class="issue-count" style="color:#8cf">üõ†Ô∏è ' + framework + '</div>' +
      (orm !== 'None' ? '<div class="issue-count" style="color:#4ade80">üíæ ' + orm + '</div>' : '');
    body.innerHTML = 
      '<div style="padding:16px">' +
        '<div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:16px">' +
          '<div style="opacity:.6">Language:</div><div style="font-weight:600">' + esc(lang) + '</div>' +
          '<div style="opacity:.6">Framework:</div><div style="font-weight:600">' + esc(framework) + '</div>' +
          '<div style="opacity:.6">ORM:</div><div style="font-weight:600">' + esc(orm) + '</div>' +
          '<div style="opacity:.6">Database:</div><div style="font-weight:600">' + esc(db) + '</div>' +
          (result.auth ? '<div style="opacity:.6">Auth:</div><div style="font-weight:600">' + esc(result.auth) + '</div>' : '') +
          (result.test ? '<div style="opacity:.6">Test Framework:</div><div style="font-weight:600">' + esc(result.test) + '</div>' : '') +
          (result.package_manager ? '<div style="opacity:.6">Package Manager:</div><div style="font-weight:600">' + esc(result.package_manager) + '</div>' : '') +
        '</div>' +
        (tools.length ? '<div><strong>Detected Tools:</strong><div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">' + tools.map(t => '<span style="background:#333;padding:4px 8px;border-radius:4px;font-size:11px">' + esc(t) + '</span>').join('') + '</div></div>' : '') +
      '</div>';
  }
  // ========== Advanced Analysis Results ==========
  else if (scanType === 'advancedFull') {
    title.innerHTML = 'üß† Full Analysis Results';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    const by_severity = summary_data.by_severity || {};
    const by_pillar = summary_data.by_pillar || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#ff5555;color:#000;font-weight:bold;">üî¥ ' + (by_severity.critical || 0) + ' Critical</div>' +
      '<div class="issue-count high">üü† ' + (by_severity.high || 0) + ' High</div>' +
      '<div class="issue-count medium">üü° ' + (by_severity.medium || 0) + ' Medium</div>' +
      '<div class="issue-count low">üü¢ ' + (by_severity.low || 0) + ' Low</div>' +
      '<div class="issue-count" style="background:#444">Total: ' + (summary_data.total_findings || findings.length) + '</div>';
    
    // Pillar breakdown
    const pillarHtml = '<div style="padding:12px 16px;background:#1a1a2e;border-bottom:1px solid var(--vscode-panel-border);display:flex;flex-wrap:wrap;gap:8px">' +
      '<span style="font-size:11px;opacity:.6">By Type:</span>' +
      (by_pillar.security ? '<span style="background:#dc2626;padding:2px 8px;border-radius:4px;font-size:11px">üîê Security: ' + by_pillar.security + '</span>' : '') +
      (by_pillar.dead_code ? '<span style="background:#6b7280;padding:2px 8px;border-radius:4px;font-size:11px">üíÄ Dead Code: ' + by_pillar.dead_code + '</span>' : '') +
      (by_pillar.quality ? '<span style="background:#7c3aed;padding:2px 8px;border-radius:4px;font-size:11px">üìê Quality: ' + by_pillar.quality + '</span>' : '') +
      (by_pillar.runtime ? '<span style="background:#ea580c;padding:2px 8px;border-radius:4px;font-size:11px">‚ö†Ô∏è Runtime: ' + by_pillar.runtime + '</span>' : '') +
      (by_pillar.dependencies ? '<span style="background:#0891b2;padding:2px 8px;border-radius:4px;font-size:11px">üì¶ Deps: ' + by_pillar.dependencies + '</span>' : '') +
      (by_pillar.copilot_style ? '<span style="background:#4f46e5;padding:2px 8px;border-radius:4px;font-size:11px">ü§ñ Copilot: ' + by_pillar.copilot_style + '</span>' : '') +
    '</div>';
    
    body.innerHTML = pillarHtml + findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'astSecurity') {
    title.innerHTML = 'üîê AST Security Scan Results';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count critical">üî¥ ' + (summary_data.critical || 0) + ' Critical</div>' +
      '<div class="issue-count high">üü† ' + (summary_data.high || 0) + ' High</div>' +
      '<div class="issue-count medium">üü° ' + (summary_data.medium || 0) + ' Medium</div>' +
      '<div class="issue-count low">üü¢ ' + (summary_data.low || 0) + ' Low</div>' +
      '<div class="issue-count">Total: ' + (result.total_findings || findings.length) + '</div>' +
      '<div class="issue-count" style="color:#8cf">üìÅ ' + (result.files_scanned || 0) + ' files</div>';
    
    body.innerHTML = findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'deadCode') {
    title.innerHTML = 'üíÄ Dead Code Detection';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#6b7280">üì• ' + (summary_data.unused_imports || 0) + ' Unused Imports</div>' +
      '<div class="issue-count" style="background:#4b5563">üîß ' + (summary_data.unused_functions || 0) + ' Unused Functions</div>' +
      '<div class="issue-count" style="background:#374151">üåê ' + (summary_data.dead_endpoints || 0) + ' Dead Endpoints</div>' +
      '<div class="issue-count">Total: ' + (result.total_findings || findings.length) + '</div>';
    
    body.innerHTML = findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'codeQuality') {
    title.innerHTML = 'üìê Code Quality Analysis';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    const metrics = result.metrics || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#dc2626">üß† ' + (summary_data.high_complexity || 0) + ' Complex</div>' +
      '<div class="issue-count" style="background:#ea580c">üìè ' + (summary_data.long_functions || 0) + ' Long Functions</div>' +
      '<div class="issue-count" style="background:#d97706">üîÄ ' + (summary_data.deep_nesting || 0) + ' Deep Nesting</div>' +
      '<div class="issue-count" style="background:#65a30d">üî¢ ' + (summary_data.many_parameters || 0) + ' Many Params</div>' +
      '<div class="issue-count" style="background:#0891b2">‚ö†Ô∏è ' + (summary_data.missing_error_handling || 0) + ' No Try/Catch</div>';
    
    const metricsHtml = '<div style="padding:12px 16px;background:#1a1a2e;border-bottom:1px solid var(--vscode-panel-border)">' +
      '<span style="font-size:11px;opacity:.6">Codebase: </span>' +
      '<span style="margin-left:8px">üìÑ ' + (metrics.total_lines || 0) + ' lines</span>' +
      '<span style="margin-left:12px">üîß ' + (metrics.total_functions || 0) + ' functions</span>' +
      '<span style="margin-left:12px">üì¶ ' + (metrics.total_classes || 0) + ' classes</span>' +
    '</div>';
    
    body.innerHTML = metricsHtml + findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'runtimeErrors') {
    title.innerHTML = '‚ö†Ô∏è Runtime Error Predictions';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#dc2626">üö´ ' + (summary_data.null_access || 0) + ' Null Access</div>' +
      '<div class="issue-count" style="background:#ea580c">üìä ' + (summary_data.bounds_check || 0) + ' Bounds</div>' +
      '<div class="issue-count" style="background:#d97706">‚è≥ ' + (summary_data.async_issues || 0) + ' Async Issues</div>' +
      '<div class="issue-count" style="background:#65a30d">‚ûó ' + (summary_data.division_zero || 0) + ' Divide by Zero</div>' +
      '<div class="issue-count" style="background:#0891b2">üîÑ ' + (summary_data.type_mismatch || 0) + ' Type Mismatch</div>';
    
    body.innerHTML = findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'dependencies') {
    title.innerHTML = 'üì¶ Dependency Analysis';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#dc2626">üîì ' + (summary_data.vulnerable_deps || 0) + ' Vulnerable</div>' +
      '<div class="issue-count" style="background:#ea580c">üîÑ ' + (summary_data.circular_imports || 0) + ' Circular</div>' +
      '<div class="issue-count" style="background:#6b7280">üì≠ ' + (summary_data.unused_deps || 0) + ' Unused</div>' +
      '<div class="issue-count" style="background:#4b5563">‚è∞ ' + (summary_data.outdated_deps || 0) + ' Outdated</div>';
    
    body.innerHTML = findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else if (scanType === 'copilotIssues') {
    title.innerHTML = 'ü§ñ Copilot-Style Issues';
    const findings = result.findings || [];
    const summary_data = result.summary || {};
    
    summary.innerHTML = folderBadge +
      '<div class="issue-count" style="background:#7c3aed">üìù ' + (summary_data.todos || 0) + ' TODOs</div>' +
      '<div class="issue-count" style="background:#4f46e5">üöß ' + (summary_data.not_implemented || 0) + ' Not Impl</div>' +
      '<div class="issue-count" style="background:#6366f1">üî¢ ' + (summary_data.magic_numbers || 0) + ' Magic Numbers</div>' +
      '<div class="issue-count" style="background:#8b5cf6">üîó ' + (summary_data.hardcoded_values || 0) + ' Hardcoded</div>' +
      '<div class="issue-count" style="background:#a78bfa">üêõ ' + (summary_data.debug_code || 0) + ' Debug Code</div>' +
      '<div class="issue-count" style="background:#c4b5fd">üìã ' + (summary_data.duplicated_code || 0) + ' Duplicates</div>';
    
    body.innerHTML = findings.slice(0, 100).map(i => renderIssueRow(i)).join('');
  }
  else {
    title.innerHTML = 'üìä Results';
    summary.innerHTML = folderBadge;
    body.innerHTML = '<div style="padding:16px"><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
  }

  // Update last results tab
  document.getElementById('lastResults').innerHTML = body.innerHTML;
}

function renderBackendStatus(status) {
  debugLog('renderBackendStatus() called: ' + JSON.stringify(status));
  
  const dot = document.getElementById('backendDot');
  const label = document.getElementById('backendLabel');
  const state = document.getElementById('backendState');
  const meta = document.getElementById('backendMeta');
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnRestart = document.getElementById('btnRestart');

  if (status.health === 'healthy') {
    dot.className = 'status-dot green';
    label.textContent = 'Backend: Running';
    state.textContent = 'Running';
    state.style.color = '#4ade80';
  } else if (status.health === 'starting') {
    dot.className = 'status-dot yellow';
    label.textContent = 'Backend: Starting...';
    state.textContent = 'Starting...';
    state.style.color = '#facc15';
  } else if (status.health === 'unhealthy') {
    dot.className = 'status-dot red';
    label.textContent = 'Backend: Error';
    state.textContent = 'Unhealthy';
    state.style.color = '#ef4444';
  } else {
    dot.className = 'status-dot gray';
    label.textContent = 'Backend: Stopped';
    state.textContent = 'Stopped';
    state.style.color = '#6b7280';
  }

  const uptimeStr = status.uptime > 0 ? (status.uptime < 60 ? status.uptime + 's' : Math.floor(status.uptime / 60) + 'm') : '‚Äî';
  meta.textContent = 'Port: ' + (status.port || 7779) + ' | PID: ' + (status.pid || '‚Äî') + ' | Uptime: ' + uptimeStr;
  document.getElementById('portNum').textContent = status.port || 7779;

  btnStart.disabled = status.running;
  btnStop.disabled = !status.running;
  btnRestart.disabled = !status.running;
}

// ============================================================
// MESSAGE HANDLER (simulates VS Code webview messages)
// ============================================================
function handleMessage(msg) {
  debugLog('handleMessage() received: ' + msg.command);
  
  switch (msg.command) {
    case 'backendStatus':
      renderBackendStatus(msg.status);
      break;
    case 'scanStarted':
      document.getElementById('scanLoading').style.display = 'block';
      document.getElementById('scanResultsPanel').style.display = 'none';
      document.getElementById('loadingText').textContent = 'Running scan...';
      document.querySelectorAll('.scan-btn').forEach(btn => btn.classList.add('loading'));
      break;
    case 'scanResults':
      renderScanResults(msg.scanType, msg.result);
      break;
    case 'scanComplete':
      document.getElementById('scanLoading').style.display = 'none';
      enableScanButtons();
      if (!msg.success) {
        const panel = document.getElementById('scanResultsPanel');
        panel.style.display = 'block';
        document.getElementById('resultsTitle').innerHTML = '‚ùå Scan Failed';
        document.getElementById('resultsSummary').innerHTML = '';
        document.getElementById('resultsBody').innerHTML = '<div class="empty-state" style="padding:20px"><div class="desc">Error: ' + esc(msg.error) + '</div></div>';
      }
      break;
  }
}

// ============================================================
// INITIALIZATION
// ============================================================
debugLog('Signaling webviewReady...');
vscode.postMessage({ command: 'webviewReady' });
debugLog('Initialization complete!');
</script>
</body>
</html>
